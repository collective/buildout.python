name: build

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  buildout-test:
    name: Test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-16.04, ubuntu-18.04, macos-latest]
        target:
          - python24
          - python25
          - python26
          - python27
          - python32
          - python33
          - python34
          - python35
          - python36
          - python37
          - python38
          - python39
          - pypy
          - pypy3

        include:
          # 24 and 32 have issues building even on 16.04
          - os: ubuntu-16.04
            target: python24
            xfail: true
          - os: ubuntu-16.04
            target: python32
            xfail: true

          # no openssl1.0 package available on 18.04?
          - os: ubuntu-18.04
            target: python24
            xfail: true
          - os: ubuntu-18.04
            target: python32
            xfail: true

    continue-on-error: ${{ matrix.xfail || false }}
    runs-on: ${{ matrix.os }}
    env:
      BUILDOUT_TARGET: ${{ matrix.target }}
    steps:
      - name: Install OSX dependencies
        if: startsWith(matrix.os, 'macos-')
        run: brew install libffi ncurses openssl

      - name: Install openssl@1.0 on OSX
        if: |
          startsWith(matrix.os, 'macos-') && contains(
            fromJSON(
              '["python24","python25","python26","python32","python33","python34"]'
            ),
            matrix.target
          )
        run: brew install mjpieters/tap/openssl@1.0

      - name: Install Linux dependencies
        if: startsWith(matrix.os, 'ubuntu-')
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev libbz2-dev libsqlite3-dev

      - name: Downgrade setuptools
        shell: bash
        run: |
          # work-around for issue 85 for the time being
          if python -m pip >/dev/null 2>&1; then
            if python -m pip show setuptools >/dev/null 2>&1; then
              sudo python -m pip install --force 'setuptools<39' || true
            fi
          fi

      - name: Check out source code
        uses: actions/checkout@v2

      - name: Run buildout
        run: make -f .github/workflows/make-tests buildout_target=$BUILDOUT_TARGET

      - name: Run executable
        shell: bash
        run: |
          if [[ "$BUILDOUT_TARGET" == python* ]]; then
              # map pythonxy to python-x.y/bin/python
              EXECUTABLE="python-${BUILDOUT_TARGET:6:1}.${BUILDOUT_TARGET:7}/bin/python"
          else
              # run pypy
              EXECUTABLE="$BUILDOUT_TARGET/bin/python"
          fi
          $EXECUTABLE -V
